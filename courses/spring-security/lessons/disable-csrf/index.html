<!DOCTYPE html><html><head><title>Disable CSRF :: Learn Spring Security :: FacadeCode</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/9f8c21078d4d48f3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9f8c21078d4d48f3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/24ff40656a656e01.css" as="style"/><link rel="stylesheet" href="/_next/static/css/24ff40656a656e01.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-a772cb4e65071da0.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-9a134ca9f5cd7bc1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-01fa0429c3abcfce.js" defer=""></script><script src="/_next/static/chunks/734-501744163e7117ce.js" defer=""></script><script src="/_next/static/chunks/428-3b4801b92e87da41.js" defer=""></script><script src="/_next/static/chunks/637-485e8fd7a429178a.js" defer=""></script><script src="/_next/static/chunks/274-faa7dc9d051cc985.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/disable-csrf-c5b0203e5053b662.js" defer=""></script><script src="/_next/static/PgbzhTeNtmRax34kBMCQo/_buildManifest.js" defer=""></script><script src="/_next/static/PgbzhTeNtmRax34kBMCQo/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->8<!-- --> of <!-- -->28</div><div class="float-end"><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Learn Spring Security</a></div></section><div class="clearfix"></div><section><div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"><div class="offcanvas-header border-bottom p-0 px-3 header_active__mLmmf"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasRight" aria-label="Close"></button></div><div class="offcanvas-body p-0"><h1 class="fw-light text-center m-3">Learn Spring Security</h1><h3 class="fs-3 text-center text-muted m-3">Contents</h3><section><div class="list-group list-group-flush"><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">01. Bootstrap The Application</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">1<!-- -->. <!-- -->Introduction</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">2<!-- -->. <!-- -->Install Spring Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">3<!-- -->. <!-- -->Enable Basic Auth</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">4<!-- -->. <!-- -->Authentication with AppUser</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">5<!-- -->. <!-- -->Password Encoder</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">02. Web Layer Security - RBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">6<!-- -->. <!-- -->Permit Public APIs</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">7<!-- -->. <!-- -->Role Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">8<!-- -->. <!-- -->Disable CSRF</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">9<!-- -->. <!-- -->Current Authenticated User</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">03. Web Layer Security - PBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">10<!-- -->. <!-- -->Permission Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">11<!-- -->. <!-- -->Define Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">12<!-- -->. <!-- -->Assign Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">13<!-- -->. <!-- -->Remove Role Based Access</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">04. Service Layer Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">14<!-- -->. <!-- -->PreAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">15<!-- -->. <!-- -->PostAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">16<!-- -->. <!-- -->Authorize Using Spring Beans</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">05. Domain Object Instance Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">17<!-- -->. <!-- -->Domain Object Instance Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">18<!-- -->. <!-- -->PermissionEvaluator Interface</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">19<!-- -->. <!-- -->PermissionEvaluator Strategy</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">20<!-- -->. <!-- -->DB Backed UserDetailsService</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">06. Token Based Authentication</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">21<!-- -->. <!-- -->Basic Authentication Revisited</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">22<!-- -->. <!-- -->Generate Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">23<!-- -->. <!-- -->Persist Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">24<!-- -->. <!-- -->Verify Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">25<!-- -->. <!-- -->Invalidate Token</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">07. Token Based Authentication and Authorization</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">26<!-- -->. <!-- -->JSON Web Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">27<!-- -->. <!-- -->Generate JWT</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">28<!-- -->. <!-- -->Verify JWT</span></div></div></div></section></div></div></section><div class="mt-5"><div class="float-end"><a href="/assets/patches/spring-security/disable-csrf.patch" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/facade-code/spring-security-for-developers/tree/disable-csrf" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Disable CSRF</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">After applying role-based authorization in the last chapter, we can access <u>ListStudents</u> and <u>ListInstructors</u> API only with users having ADMIN role. Similarly we can access <u>CreateCourse</u> API only with users having INSTRUCTOR role. Let&#x27;s create a new course by sending a POST request to <u>CreateCourse</u> API with Gru who has INSTRUCTOR role.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>403 Forbidden error returned for Gru (Instructor) while accessing Create Course API</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson08-01.png" alt="403 Forbidden error returned for Gru (Instructor) while accessing Create Course API"/></div><p class="Paragraph_paragraph__90U8D">Surprisingly we have got <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">403 Forbidden</mark> error even though Gru has the INSTRUCTOR role. Let&#x27;s update the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">application.properties</mark> in order to enable the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DEBUG</mark> log for Spring Security and see what is happening behind the scene.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/disable-csrf/src/main/resources/application.properties" target="_blank">application.properties</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
logging.level.org.springframework.security=DEBUG    
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Restart the application and send the same request again. You can see an error stating <strong><em>&quot;Invalid CSRF token found for http://localhost:8080/api/v1/courses&quot;</em></strong> in the log something like below:</p><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
o.s.security.web.FilterChainProxy        : Securing POST /api/v1/courses
w.c.HttpSessionSecurityContextRepository : Retrieved SecurityContextImpl [...]
s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to SecurityContextImpl [...]
o.s.security.web.csrf.CsrfFilter         : Invalid CSRF token found <span class="hljs-keyword">for</span> http:<span class="hljs-comment">//localhost:8080/api/v1/courses</span>
o.s.s.w.access.AccessDeniedHandlerImpl   : Responding with <span class="hljs-number">403</span> status code
s.s.w.c.SecurityContextPersistenceFilter : Cleared SecurityContextHolder to complete request
o.s.security.web.FilterChainProxy        : Securing POST /error
w.c.HttpSessionSecurityContextRepository : Retrieved SecurityContextImpl [...]
s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to SecurityContextImpl [...]
o.s.s.w.a.i.FilterSecurityInterceptor    : Authorized filter invocation [POST /error] with attributes [authenticated]
o.s.security.web.FilterChainProxy        : Secured POST /error
s.s.w.c.SecurityContextPersistenceFilter : Cleared SecurityContextHolder to complete request   
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">What is CSRF and CSRF Token?</h3><p class="Paragraph_paragraph__90U8D">Cross-Site Request Forgery (CSRF) is an attack that forces authenticated users to submit a request to a Web application in which they are currently authenticated.</p><p class="Paragraph_paragraph__90U8D">Assume you are browsing through an evil website, while still logged in with your Banks&#x27; website. The evil website can force you to click an image, link or button, which then can send an unsolicited fund transfer request to your Bank&#x27;s website from the evil website. Though the evil website can not see your cookies, the cookies associated with your Bank&#x27;s website are still sent along with your request. And your Bank&#x27;s website in no way can differentiate this malicious request, it executes the requested fund transfer.</p><p class="Paragraph_paragraph__90U8D">CSRF attacks can be prevented using CSRF token, a secure random token unique per user session known only to the application and it&#x27;s user interface.</p></section><section><h3 class="fw-light mt-5 mb-2">When to use CSRF protection</h3><p class="Paragraph_paragraph__90U8D">CSRF protection is enabled by default in Spring Security for those <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpMethod</mark> which potentially can change the state of the application: POST, PUT, DELETE and/or PATCH.</p><p class="Paragraph_paragraph__90U8D">Spring Security recommends to use CSRF protection for any request that could be processed by a browser by normal users. If you are only creating a service that is used by non-browser clients, you will likely want to disable CSRF protection.</p></section><section><h3 class="fw-light mt-5 mb-2">Disable CSRF protection</h3><p class="Paragraph_paragraph__90U8D">For the purpose of our course, let&#x27;s disable CSRF by chaining <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">csrf().disable()</mark> method call with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/disable-csrf/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java" target="_blank">ApiSecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiSecurityConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">apiFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .csrf().disable()
            .authorizeRequests(auth -&gt; auth
                .antMatchers(GET, PUBLIC_API_LIST).permitAll()
                .antMatchers(API_LIST_STUDENTS, API_LIST_INSTRUCTORS).hasRole(ADMIN.name())
                .antMatchers(POST, API_CREATE_COURSES).hasRole(INSTRUCTOR.name())
                .anyRequest().authenticated()
            )
            .httpBasic();
        <span class="hljs-keyword">return</span> http.build();
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">If we send the <u>CreateCourse</u> API request again with Gru after restarting the application, we can see the course got created with <em>201 Created</em> status. Whereas it throws <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">403 Forbidden</mark> error for the users who does not have the INSTRUCTOR role.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>New course created for Gru after disabling CSRF</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson08-02.png" alt="New course created for Gru after disabling CSRF"/></div></section><div class="mt-5"><section><div class="row border-top border-bottom py-2 mt-2"><div class="col-12 col-md-6 col-lg-6 text-center text-md-start"><div><div class="text-muted"><i class="bi-arrow-left-short mx-1 align-middle invisible d-none d-md-inline-block"></i>Previous</div><div><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i><a href="/courses/spring-security/lessons/role-based-authorization/">Role Based Authorization</a></div></div></div><div class="col-12 col-md-6 col-lg-6 text-center text-md-end"><div><div class="text-muted">Next<i class="bi-arrow-right-short mx-1 align-middle invisible d-none d-md-inline-block"></i></div><div><a href="/courses/spring-security/lessons/current-authenticated-user/">Current Authenticated User</a><i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></div></div></div></div></section></div></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="bg-dark"><div class="py-5"><div class="container"><div class="row"><div class="col-12 col-md-6 m-3 m-md-0"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><div class="logo_logoCaption__h__G1">Simple bite-sized lessons to learn complex concepts</div></div><div class="col-12 col-md-3 m-3 m-md-0"><a href="/aboutme" class="footer_home__36kMG"><strong>ABOUT ME</strong></a></div><div class="col-12 col-md-3 m-3 m-md-0"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div><div class="text-center py-2 footer_copyright__mlBDD">Copyright © 2022 FacadeCode</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/disable-csrf","query":{},"buildId":"PgbzhTeNtmRax34kBMCQo","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>