<!DOCTYPE html><html><head><title>Domain Object Instance Security :: Learn Spring Security :: FacadeCode</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/9f8c21078d4d48f3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9f8c21078d4d48f3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/24ff40656a656e01.css" as="style"/><link rel="stylesheet" href="/_next/static/css/24ff40656a656e01.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-a772cb4e65071da0.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-9a134ca9f5cd7bc1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-01fa0429c3abcfce.js" defer=""></script><script src="/_next/static/chunks/734-501744163e7117ce.js" defer=""></script><script src="/_next/static/chunks/428-3b4801b92e87da41.js" defer=""></script><script src="/_next/static/chunks/637-485e8fd7a429178a.js" defer=""></script><script src="/_next/static/chunks/274-faa7dc9d051cc985.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/domain-object-instance-security-bbeabe37e81bb93e.js" defer=""></script><script src="/_next/static/PgbzhTeNtmRax34kBMCQo/_buildManifest.js" defer=""></script><script src="/_next/static/PgbzhTeNtmRax34kBMCQo/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->17<!-- --> of <!-- -->28</div><div class="float-end"><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Learn Spring Security</a></div></section><div class="clearfix"></div><section><div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"><div class="offcanvas-header border-bottom p-0 px-3 header_active__mLmmf"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasRight" aria-label="Close"></button></div><div class="offcanvas-body p-0"><h1 class="fw-light text-center m-3">Learn Spring Security</h1><h3 class="fs-3 text-center text-muted m-3">Contents</h3><section><div class="list-group list-group-flush"><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">01. Bootstrap The Application</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">1<!-- -->. <!-- -->Introduction</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">2<!-- -->. <!-- -->Install Spring Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">3<!-- -->. <!-- -->Enable Basic Auth</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">4<!-- -->. <!-- -->Authentication with AppUser</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">5<!-- -->. <!-- -->Password Encoder</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">02. Web Layer Security - RBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">6<!-- -->. <!-- -->Permit Public APIs</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">7<!-- -->. <!-- -->Role Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">8<!-- -->. <!-- -->Disable CSRF</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">9<!-- -->. <!-- -->Current Authenticated User</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">03. Web Layer Security - PBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">10<!-- -->. <!-- -->Permission Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">11<!-- -->. <!-- -->Define Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">12<!-- -->. <!-- -->Assign Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">13<!-- -->. <!-- -->Remove Role Based Access</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">04. Service Layer Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">14<!-- -->. <!-- -->PreAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">15<!-- -->. <!-- -->PostAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">16<!-- -->. <!-- -->Authorize Using Spring Beans</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">05. Domain Object Instance Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">17<!-- -->. <!-- -->Domain Object Instance Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">18<!-- -->. <!-- -->PermissionEvaluator Interface</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">19<!-- -->. <!-- -->PermissionEvaluator Strategy</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">20<!-- -->. <!-- -->DB Backed UserDetailsService</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">06. Token Based Authentication</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">21<!-- -->. <!-- -->Basic Authentication Revisited</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">22<!-- -->. <!-- -->Generate Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">23<!-- -->. <!-- -->Persist Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">24<!-- -->. <!-- -->Verify Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">25<!-- -->. <!-- -->Invalidate Token</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">07. Token Based Authentication and Authorization</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">26<!-- -->. <!-- -->JSON Web Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">27<!-- -->. <!-- -->Generate JWT</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">28<!-- -->. <!-- -->Verify JWT</span></div></div></div></section></div></div></section><div class="mt-5"><div class="float-end"><a href="/assets/patches/spring-security/domain-object-instance-security.patch" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/facade-code/spring-security-for-developers/tree/domain-object-instance-security" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Domain Object Instance Security</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Remember we assigned PLAY_COURSE and UPDATE_COURSE permissions to the STUDENT and INSTRUCTOR roles respectively. It allows any Students to play any course, similarly any Instructors can update any course. But our objective is to</p><ol><li>Play only the courses enrolled by the Student.</li><li>Update only the courses created by the Instructor.</li></ol><p class="Paragraph_paragraph__90U8D">In order to achieve this we need to enhance the security of these two service methods in addition to the permissions assigned. Obviously we can implement the authorization checks in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ServiceSecurity</mark> bean similar to what we did in the previous chapter for <u>ViewProfile</u>:</p><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-comment">// PLAY_COURSE permission - Check if the course is enrolled by the authenticated user</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnrolledStudent</span><span class="hljs-params">(Authentication authentication, Long courseId)</span> {
    Optional&lt;AppUser&gt; student = appUserRepository.findByUsername(authentication.getName());
    <span class="hljs-keyword">if</span> (student.isPresent()) {
        <span class="hljs-keyword">return</span> student.get()
                .getEnrolledCourses()
                .stream()
                .anyMatch(course -&gt; course.getId().equals(courseId));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</span></code></pre></div><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-comment">// UPDATE_COURSE permission - Check if the course is created by the authenticated user</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCreatedBy</span><span class="hljs-params">(Authentication authentication, Long courseId)</span> {
    Optional&lt;Course&gt; course = courseRepository.findById(courseId);
    <span class="hljs-keyword">if</span> (course.isPresent()) {
        <span class="hljs-keyword">return</span> course.get()
              .getCreatedBy()
              .getUsername()
              .equalsIgnoreCase(authentication.getName());
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">hasPermission() - SpEL Expression</h3><p class="Paragraph_paragraph__90U8D">So far we have covered Web Request Security and Service Layer Security, but what we are dealing now is all about securing the domain object instances i.e., Who can do what on a specific Course? And it requires a different approach.</p><p class="Paragraph_paragraph__90U8D">Similar to <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasRole()</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark>, Spring Security offers below built-in SpEL expressions to achieve domain object instance security.</p><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
hasPermission(Object targetDomainObject, Object permission);

hasPermission(Serializable targetId, String targetType, Object permission);
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Update Authority </h3><p class="Paragraph_paragraph__90U8D">Let&#x27;s replace <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> expression for PLAY_COURSE and UPDATE_COURSE constants in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authority</mark> class.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/permission-evaluator-interface/src/main/java/com/facadecode/spring/security/constant/SecurityConstants.java" target="_blank">Authority.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Authority</span> {
  <span class="hljs-comment">// Other constants omitted for brevity</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PLAY_COURSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasPermission(#courseId, T(com.thecodefacts.spring.security.domain.Course).getSimpleName(), T(com.thecodefacts.spring.security.enums.PermissionEnum).PLAY_COURSE.name())&quot;</span>;
  
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">UPDATE_COURSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasPermission(#courseId, T(com.thecodefacts.spring.security.domain.Course).getSimpleName(), T(com.thecodefacts.spring.security.enums.PermissionEnum).UPDATE_COURSE.name())&quot;</span>;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Here the first parameter <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">#courseId</mark> corresponds to the argument with the same name defined in the corresponding service methods. And it represents the unique <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ID</mark> of the Course object. Second parameter represents the type of the target domain object. Third parameter represents the permission required to authorize the service method execution.</p><p class="Paragraph_paragraph__90U8D">With <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasRole()</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> expressions, Spring Security automatically verified if the authenticated user has the given role or permission. But with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> expression, we can ask below two questions:</p><ol><li>Who will implement the authorization check for the hasPermission() SpEL expression?</li><li>How do we get the authenticated user details to check for the given permission?</li></ol></section><section><h3 class="fw-light mt-5 mb-2">PermissionEvaluator</h3><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> expressions are basically delegated to an instance of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> interface, which has two methods:</p><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(Authentication authentication, Object targetDomainObject, Object permission)</span>;

<span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(Authentication authentication, Serializable targetId, String targetType, Object permission)</span>;
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">These methods map directly to the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> SpEL expression with the exception that the first argument <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object will be passed automatically by Spring Security.</p><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> interface is intended to be the bridge between Spring&#x27;s SpEL expression system and Spring Security&#x27;s ACL System to implement domain object instance security. But it does not ship with standard Spring Security framework, we need to manually add  <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">spring-security-acl-xxx.jar</mark> as mvn dependency in pom.xml.</p></section><section><h3 class="fw-light mt-5 mb-2">What is Spring Security&#x27;s ACL?</h3><p class="Paragraph_paragraph__90U8D">Access Control List (ACL) looks similar to the Security tab you can find in the Windows system in file properties for each file resource. It maintains the list of users and their permissions on the respective file resource.</p><p class="Paragraph_paragraph__90U8D">Similarly Spring Security&#x27;s ACL system works based on the permissions granted for each user on each domain object instances. This ACL information is stored in the database which will be used exclusively by <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">spring-security-acl-xxx.jar</mark>.</p><h4 class="fw-light mt-5 mb-2">Downside of ACL</h4><p class="Paragraph_paragraph__90U8D">Spring Security&#x27;s ACL is great and easier to write but it does not scale well for some of the following reasons.</p><ol><li>Assume an application having 1 Million object instances, 1000 users and a minimum of four basic actions (CRUD) = 4 Billion ACL records. Imagine a query executing on these many records for each Service method invocation. This can potentially cause performance issues and can become a maintenance nightmare.</li><li>ACL records are normally stored with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ID</mark> of the subject and the object together with the permissions in the database table. So ACL systems are basically driven by the identifiers of the subject and the object, not by their attributes. This in itself have few practical issues listed below:</li></ol><ol type="a" class="ms-5"><li>We can&#x27;t understand from the ACL table who can do what on which domain object instances.</li><li>It is also nearly impossible to understand the rules driving the granted permissions.</li><li>Any change in the attributes of the subject or object requires constant updation of these ACL records.</li><li>Any change in the requirement change in terms of granted permissions require a huge insert/update/deletion of these ACL records corresponding to the impacted subject associated with the object under authorization.</li></ol></section><section><h3 class="fw-light mt-5 mb-2">Attribute-based Access Control (ABAC)</h3><p class="Paragraph_paragraph__90U8D">The drawbacks of ACL can be overcome by Attribute-based access control (ABAC) or Policy-based access control (PBAC). ABAC is different and a recently popular authorization mechanism to secure the domain object instances.</p><p class="Paragraph_paragraph__90U8D">XACML is a specification to define and evaluate such attribute-based access control policies. But we are not going to cover XACML here, we will then be deviating from Spring Security. If all your access control needs can be implemented by simple patterns and conditions within the context of your domain model, specifications like XACML will be an overkill for small and medium-sized applications.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s see how we are going to implement ABAC with Spring Security&#x27;s <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> interface in the coming chapters.</p></section><div class="mt-5"><section><div class="row border-top border-bottom py-2 mt-2"><div class="col-12 col-md-6 col-lg-6 text-center text-md-start"><div><div class="text-muted"><i class="bi-arrow-left-short mx-1 align-middle invisible d-none d-md-inline-block"></i>Previous</div><div><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i><a href="/courses/spring-security/lessons/authorize-using-spring-beans/">Authorize Using Spring Beans</a></div></div></div><div class="col-12 col-md-6 col-lg-6 text-center text-md-end"><div><div class="text-muted">Next<i class="bi-arrow-right-short mx-1 align-middle invisible d-none d-md-inline-block"></i></div><div><a href="/courses/spring-security/lessons/permission-evaluator-interface/">PermissionEvaluator Interface</a><i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></div></div></div></div></section></div></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="bg-dark"><div class="py-5"><div class="container"><div class="row"><div class="col-12 col-md-6 m-3 m-md-0"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><div class="logo_logoCaption__h__G1">Simple bite-sized lessons to learn complex concepts</div></div><div class="col-12 col-md-3 m-3 m-md-0"><a href="/aboutme" class="footer_home__36kMG"><strong>ABOUT ME</strong></a></div><div class="col-12 col-md-3 m-3 m-md-0"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div><div class="text-center py-2 footer_copyright__mlBDD">Copyright © 2022 FacadeCode</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/domain-object-instance-security","query":{},"buildId":"PgbzhTeNtmRax34kBMCQo","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>