<!DOCTYPE html><html><head><title>Verify JWT :: Learn Spring Security :: FacadeCode</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/9f8c21078d4d48f3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9f8c21078d4d48f3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/85fdc14739e57ee1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/85fdc14739e57ee1.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-a772cb4e65071da0.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-9a134ca9f5cd7bc1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-01fa0429c3abcfce.js" defer=""></script><script src="/_next/static/chunks/734-501744163e7117ce.js" defer=""></script><script src="/_next/static/chunks/428-3b4801b92e87da41.js" defer=""></script><script src="/_next/static/chunks/637-485e8fd7a429178a.js" defer=""></script><script src="/_next/static/chunks/274-faa7dc9d051cc985.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/verify-jwt-24d40a1f5a50896a.js" defer=""></script><script src="/_next/static/PgbzhTeNtmRax34kBMCQo/_buildManifest.js" defer=""></script><script src="/_next/static/PgbzhTeNtmRax34kBMCQo/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->28<!-- --> of <!-- -->28</div><div class="float-end"><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Learn Spring Security</a></div></section><div class="clearfix"></div><section><div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"><div class="offcanvas-header border-bottom p-0 px-3 header_active__mLmmf"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasRight" aria-label="Close"></button></div><div class="offcanvas-body p-0"><h1 class="fw-light text-center m-3">Learn Spring Security</h1><h3 class="fs-3 text-center text-muted m-3">Contents</h3><section><div class="list-group list-group-flush"><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">01. Bootstrap The Application</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">1<!-- -->. <!-- -->Introduction</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">2<!-- -->. <!-- -->Install Spring Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">3<!-- -->. <!-- -->Enable Basic Auth</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">4<!-- -->. <!-- -->Authentication with AppUser</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">5<!-- -->. <!-- -->Password Encoder</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">02. Web Layer Security - RBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">6<!-- -->. <!-- -->Permit Public APIs</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">7<!-- -->. <!-- -->Role Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">8<!-- -->. <!-- -->Disable CSRF</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">9<!-- -->. <!-- -->Current Authenticated User</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">03. Web Layer Security - PBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">10<!-- -->. <!-- -->Permission Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">11<!-- -->. <!-- -->Define Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">12<!-- -->. <!-- -->Assign Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">13<!-- -->. <!-- -->Remove Role Based Access</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">04. Service Layer Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">14<!-- -->. <!-- -->PreAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">15<!-- -->. <!-- -->PostAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">16<!-- -->. <!-- -->Authorize Using Spring Beans</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">05. Domain Object Instance Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">17<!-- -->. <!-- -->Domain Object Instance Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">18<!-- -->. <!-- -->PermissionEvaluator Interface</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">19<!-- -->. <!-- -->PermissionEvaluator Strategy</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">20<!-- -->. <!-- -->DB Backed UserDetailsService</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">06. Token Based Authentication</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">21<!-- -->. <!-- -->Basic Authentication Revisited</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">22<!-- -->. <!-- -->Generate Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">23<!-- -->. <!-- -->Persist Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">24<!-- -->. <!-- -->Verify Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">25<!-- -->. <!-- -->Invalidate Token</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">07. Token Based Authentication and Authorization</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">26<!-- -->. <!-- -->JSON Web Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">27<!-- -->. <!-- -->Generate JWT</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">28<!-- -->. <!-- -->Verify JWT</span></div></div></div></section></div></div></section><div class="mt-5"><div class="float-end"><a href="/assets/patches/spring-security/verify-jwt.patch" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/facade-code/spring-security-for-developers/tree/verify-jwt" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Verify JWT</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">As JWT is self-contained with the Subject information to whom the token is issued, we do not need to associate the token with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record in the database. Because of which we no longer need to identify the user from the database as well. All we need is just to verify the signature using the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> and parse the JWT to construct the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as authenticated principal.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s update <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerificationFilter</mark>, by replacing the existing logic to identify the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> from the database using opaque token, with the below code:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/verify-jwt/src/main/java/com/facadecode/spring/security/filters/TokenVerificationFilter.java" target="_blank">TokenVerificationFilter.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Override</span>  
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, 
            HttpServletResponse response, 
            FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
    <span class="hljs-type">String</span> <span class="hljs-variable">authorizationHeader</span> <span class="hljs-operator">=</span> request.getHeader(HttpHeaders.AUTHORIZATION);

    <span class="hljs-keyword">if</span> (authorizationHeader != <span class="hljs-literal">null</span> &amp;&amp; authorizationHeader.startsWith(<span class="hljs-string">&quot;Bearer &quot;</span>)) {
        <span class="hljs-type">String</span> <span class="hljs-variable">accessToken</span> <span class="hljs-operator">=</span> authorizationHeader.replace(<span class="hljs-string">&quot;Bearer &quot;</span>, <span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-comment">// Parse JWT using the SecretKey</span>
        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> Jwts.parserBuilder()
            .setSigningKey(jwtConfig.getSecretKey())
            .build()
            .parseClaimsJws(accessToken)
            .getBody();

        <span class="hljs-comment">// Check if JWT has expired</span>
        <span class="hljs-keyword">if</span> (claims.getExpiration().after(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())) {
            <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.authenticated(
                    claims.getSubject(), <span class="hljs-literal">null</span>, <span class="hljs-built_in">this</span>.getAuthorities(claims)
            );
            authenticationFacade.setAuthentication(authentication);
        }
    }

    filterChain.doFilter(request, response);
}

<span class="hljs-keyword">private</span> List&lt;GrantedAuthority&gt; <span class="hljs-title function_">getAuthorities</span><span class="hljs-params">(Claims claims)</span> {
    <span class="hljs-keyword">return</span> ((List&lt;String&gt;) claims.get(<span class="hljs-string">&quot;authorities&quot;</span>)).stream()
        .map(SimpleGrantedAuthority::<span class="hljs-keyword">new</span>)
        .collect(Collectors.toList());
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Jwts</mark> provides another Builder class <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParserBuilder</mark> to build <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParser</mark> object. We are calling <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">parseClaimsJws()</mark> method on <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParser</mark> which accepts <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> to verify the signature and parse the content of JWT.</p><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">You may notice another parser method <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">parseClaimsJwt()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParser</mark>. But we are using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">parseClaimsJws()</mark> because signed JWT tokens are called JWS (not JWT), and in our case we want to parse the JWS signed with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark>.</p></section><p class="Paragraph_paragraph__90U8D">The parsed JWT body has the information we saw earlier in the decoded payload data in the JWT official page. Now instead of identifying the user and his authorities from the database, we can get the same from the JWT payload. But before creating <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object form the JWT payload we have to check if the token has expired.</p></section><section><h3 class="fw-light mt-5 mb-2">Tidy up and Test</h3><p class="Paragraph_paragraph__90U8D">We can remove the <em>token</em> and <em>tokenExpiryTime</em> from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> entity as we are not using it anymore. We can also tidy up some of the code related to opaque token which are no more relevant with JWT.</p><ul class="overflow-auto py-3"><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">invalidateToken()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationController</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark>.</li><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark>.</li><li>Remove pre-authorize condition defined for <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityConstants</mark>.</li><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadUserByToken()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailsService</mark>.</li><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">findByTokenAndTokenExpiryTimeGreaterThan()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUserRepository</mark>.</li></ul><p class="Paragraph_paragraph__90U8D">Restart the application and get the JWT generated for <em>Admin</em> user credentials by sending a POST request to <u>GenerateToken</u> API.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>JWT generated for Admin user credentials on successful authentication</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson28-01.png" alt="JWT generated for Admin user credentials on successful authentication"/></div><p class="Paragraph_paragraph__90U8D">Now choose the Authorization type as <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Bearer Token</mark>, and paste the generated JWT in the Token Field. If we send a GET request to <u>ListStudents</u> API with JWT as the Bearer Token in the Authorization header, <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerificationFilter</mark> will verify the signature of JWS and parse the content to create <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as an authenticated principal. Rest of the token-based authentication process remains the same as with our opaque token.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>List of students response for the authorized JWT issed for Admin user</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson28-02.png" alt="List of students response for the authorized JWT issed for Admin user"/></div><p class="Paragraph_paragraph__90U8D">Similarly you can test for all the other protected resources for all the users with their respective JWT.</p><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Conclusion</h4><p class="Paragraph_paragraph__90U8D">We reached the epic conclusion of this course. I hope you have got a better knowledge on how to secure every layer of an application from the scratch using some of the widely used concepts in Spring Security.</p><p class="Paragraph_paragraph__90U8D">I will update this course constantly as and when we get new releases in Spring Security. Please reach out to me in email for any improvements or additions. My email address is <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">email [at] this website name</mark>.</p></section></section><div class="mt-5"><section><div class="row border-top border-bottom py-2 mt-2"><div class="col-12 col-md-6 col-lg-6 text-center text-md-start"><div><div class="text-muted"><i class="bi-arrow-left-short mx-1 align-middle invisible d-none d-md-inline-block"></i>Previous</div><div><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i><a href="/courses/spring-security/lessons/generate-jwt/">Generate JWT</a></div></div></div><div class="col-12 col-md-6 col-lg-6 text-center text-md-end"></div></div></section></div></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="bg-dark"><div class="py-5"><div class="container"><div class="row"><div class="col-12 col-md-6 m-3 m-md-0"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><div class="logo_logoCaption__h__G1">Simple bite-sized lessons to learn complex concepts</div></div><div class="col-12 col-md-3 m-3 m-md-0"><a href="/aboutme" class="footer_home__36kMG"><strong>ABOUT ME</strong></a></div><div class="col-12 col-md-3 m-3 m-md-0"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div><div class="text-center py-2 footer_copyright__mlBDD">Copyright © 2022 FacadeCode</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/verify-jwt","query":{},"buildId":"PgbzhTeNtmRax34kBMCQo","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>