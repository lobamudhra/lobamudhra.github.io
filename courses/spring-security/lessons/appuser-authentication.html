<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/9f8c21078d4d48f3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9f8c21078d4d48f3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/24ff40656a656e01.css" as="style"/><link rel="stylesheet" href="/_next/static/css/24ff40656a656e01.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-a772cb4e65071da0.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-190aa21c2c3f601a.js" defer=""></script><script src="/_next/static/chunks/734-501744163e7117ce.js" defer=""></script><script src="/_next/static/chunks/428-3b4801b92e87da41.js" defer=""></script><script src="/_next/static/chunks/637-485e8fd7a429178a.js" defer=""></script><script src="/_next/static/chunks/274-8c280538e303b201.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/appuser-authentication-07a09c15e442d06c.js" defer=""></script><script src="/_next/static/jrh1wZfexw-7t3We4dymB/_buildManifest.js" defer=""></script><script src="/_next/static/jrh1wZfexw-7t3We4dymB/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/icon?family=Material+Icons">@font-face{font-family:'Material Icons';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNa.woff) format('woff')}.material-icons{font-family:'Material Icons';font-weight:normal;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;font-feature-settings:'liga'}@font-face{font-family:'Material Icons';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNcIhQ8tQ.woff2) format('woff2')}.material-icons{font-family:'Material Icons';font-weight:normal;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-feature-settings:'liga';-webkit-font-smoothing:antialiased}</style></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->4<!-- --> of <!-- -->28</div><div class="float-end"><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Spring Security</a></div></section><div class="clearfix"></div><section><div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"><div class="offcanvas-header border-bottom p-0 px-3 header_active__mLmmf"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasRight" aria-label="Close"></button></div><div class="offcanvas-body p-0"><h1 class="fw-light text-center m-3">Spring Security</h1><h3 class="fs-3 text-center text-muted m-3">Contents</h3><section><div class="list-group list-group-flush"><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">01. Bootstrap The Application</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">1<!-- -->. <!-- -->Introduction</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">2<!-- -->. <!-- -->Install Spring Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">3<!-- -->. <!-- -->Enable Basic Auth</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6 Contents_active__vP5PJ"><span class="px-4">4<!-- -->. <!-- -->Authentication with AppUser</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">5<!-- -->. <!-- -->Password Encoder</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">02. Web Layer Security - RBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">6<!-- -->. <!-- -->Permit Public APIs</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">7<!-- -->. <!-- -->Role Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">8<!-- -->. <!-- -->Disable CSRF</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">9<!-- -->. <!-- -->Current Authenticated User</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">03. Web Layer Security - PBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">10<!-- -->. <!-- -->Permission Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">11<!-- -->. <!-- -->Define Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">12<!-- -->. <!-- -->Assign Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">13<!-- -->. <!-- -->Remove Role Based Access</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">04. Service Layer Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">14<!-- -->. <!-- -->PreAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">15<!-- -->. <!-- -->PostAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">16<!-- -->. <!-- -->Authorize Using Spring Beans</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">05. Domain Object Instance Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">17<!-- -->. <!-- -->Domain Object Instance Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">18<!-- -->. <!-- -->PermissionEvaluator Interface</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">19<!-- -->. <!-- -->PermissionEvaluator Strategy</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">20<!-- -->. <!-- -->DB Backed UserDetailsService</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">06. Token Based Authentication</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">21<!-- -->. <!-- -->Basic Authentication Revisited</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">22<!-- -->. <!-- -->Generate Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">23<!-- -->. <!-- -->Persist Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">24<!-- -->. <!-- -->Verify Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">25<!-- -->. <!-- -->Invalidate Token</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">07. Token Based Authentication and Authorization</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">26<!-- -->. <!-- -->JSON Web Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">27<!-- -->. <!-- -->Generate JWT</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">28<!-- -->. <!-- -->Verify JWT</span></div></div></div></section></div></div></section><div class="mt-5"><div class="float-end"><a href="/assets/patches/spring-security/appuser-authentication.patch" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/facade-code/spring-security-for-developers/tree/appuser-authentication" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Authentication with AppUser</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">So far we have authenticated using the default user and the random password provided by Spring Security. But as in any web applications we want to authenticate using our application users, which were created in the database by <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppDataInitialiser</mark> when the application bootstraps. Let&#x27;s see how we can do this using one of the implementations of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetailsService</mark> provided by Spring Security.</p></section><section><h3 class="fw-light mt-5 mb-2">InMemoryUserDetailsManager</h3><p class="Paragraph_paragraph__90U8D">Spring Security uses <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetailsService</mark> as the core interface to load user-specific data by username, and it requires only one read-only method.</p><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> {
    UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span>
            <span class="hljs-keyword">throws</span> UsernameNotFoundException;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">InMemoryUserDetailsManager</mark> is one of the implementations provided by Spring Security. It is a non-persistant implementation backed by an in-memory map mainly intended for testing and demonstration purposes only. It accepts a collection of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> objects, which is the same as the return type of the above <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadUserByUsername()</mark> method.</p></section><section><h3 class="fw-light mt-5 mb-2">Create UserDetails from database</h3><p class="Paragraph_paragraph__90U8D">Before registering <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">InMemoryUserDetailsManager</mark> bean, let&#x27;s create a collection of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> objects. We can do this by fetching all the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> records from the database, map them all with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">User</mark> class and return the collection from a <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@Service</mark> method like below.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/appuser-authentication/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DbUserDetailsService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AppUserRepository appUserRepository;

    <span class="hljs-keyword">public</span> List&lt;UserDetails&gt; <span class="hljs-title function_">getAllUserDetails</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> appUserRepository.findAll()
                .stream()
                .map(appUser -&gt; User.builder()
                        .username(appUser.getUsername())
                        .password(String.format(<span class="hljs-string">&quot;{noop}%s&quot;</span>, appUser.getPassword()))
                        .authorities(Collections.EMPTY_SET)
                        .build()
                )
                .collect(Collectors.toList());
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">User</mark> is one of the implementations of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> interface with a convenient Builder class. Here we have mapped <em>username</em> and <em>password</em> only and left the authorities as an empty <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Set</mark> as we are focusing only on authenticating application users for now.</p><p class="Paragraph_paragraph__90U8D">We must provide the correct password encoding schema used to encode the passwords stored in the database. We can do this by prefixing each password with the appropriate string literal representing the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PasswordEncoder</mark>. In our case we have not encrypted the passwords in the database, we are prefixing it with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">{noop}</mark>. This prefix tells Spring Security to use <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">NoOpPasswordEncoder</mark> for password verification while authenticating the application user.</p></section><section><h3 class="fw-light mt-5 mb-2">Register InMemoryUserDetailsManager Bean</h3><p class="Paragraph_paragraph__90U8D">Now with the list of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> objects in hand, we can create and register an <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">InMemoryUserDetailsManager</mark> bean inside a new <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@Configuration</mark> class like below.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/appuser-authentication/src/main/java/com/facadecode/spring/security/config/SecurityBean.java" target="_blank">SecurityBean.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityBean</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DbUserDetailsService dbUserDetailsService;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(
                dbUserDetailsService.getAllUserDetails()
        );
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Verify authentication using AppUser</h3><p class="Paragraph_paragraph__90U8D">When we restart the application, we can notice Spring Security is no longer generating the random password. And it no longer creates the default user also. It uses <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">InMemoryUserDetailsManager</mark> bean to hold the list of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> mapped from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> records in the database.</p><p class="Paragraph_paragraph__90U8D">We can use any of these AppUser from the database to authenticate in order to access the secured REST APIs. Let&#x27;s use Bob and his credential to access the <u>ListStudents</u> API in Postman using Basic Auth.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>List of all student records returned for the application user (Bob)</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson05-02.png" alt="List of all student records returned for the application user (Bob)"/></div></section><div class="mt-5"><section><div class="row border-top border-bottom py-2 mt-2"><div class="col-12 col-md-6 col-lg-6 text-center text-md-start"><div><div class="text-muted"><i class="bi-arrow-left-short mx-1 align-middle invisible d-none d-md-inline-block"></i>Previous</div><div><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i><a href="/courses/spring-security/lessons/enable-basic-auth">Enable Basic Auth</a></div></div></div><div class="col-12 col-md-6 col-lg-6 text-center text-md-end"><div><div class="text-muted">Next<i class="bi-arrow-right-short mx-1 align-middle invisible d-none d-md-inline-block"></i></div><div><a href="/courses/spring-security/lessons/password-encoder">Password Encoder</a><i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></div></div></div></div></section></div></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="bg-dark"><div class="py-5"><div class="container"><div class="row"><div class="col-12 col-md-6 m-3 m-md-0"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><div class="logo_logoCaption__h__G1">Simple bite-sized lessons to learn complex concepts</div></div><div class="col-12 col-md-3 m-3 m-md-0"><a href="/aboutme" class="footer_home__36kMG"><strong>ABOUT ME</strong></a></div><div class="col-12 col-md-3 m-3 m-md-0"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div><div class="text-center py-2 footer_copyright__mlBDD">Copyright © 2022 FacadeCode</div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/appuser-authentication","query":{},"buildId":"jrh1wZfexw-7t3We4dymB","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>