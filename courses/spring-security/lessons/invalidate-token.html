<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/9f8c21078d4d48f3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9f8c21078d4d48f3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/85fdc14739e57ee1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/85fdc14739e57ee1.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-a772cb4e65071da0.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-190aa21c2c3f601a.js" defer=""></script><script src="/_next/static/chunks/734-501744163e7117ce.js" defer=""></script><script src="/_next/static/chunks/428-3b4801b92e87da41.js" defer=""></script><script src="/_next/static/chunks/637-485e8fd7a429178a.js" defer=""></script><script src="/_next/static/chunks/274-8c280538e303b201.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/invalidate-token-5de59cb6facf188e.js" defer=""></script><script src="/_next/static/jrh1wZfexw-7t3We4dymB/_buildManifest.js" defer=""></script><script src="/_next/static/jrh1wZfexw-7t3We4dymB/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/icon?family=Material+Icons">@font-face{font-family:'Material Icons';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNa.woff) format('woff')}.material-icons{font-family:'Material Icons';font-weight:normal;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;font-feature-settings:'liga'}@font-face{font-family:'Material Icons';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNcIhQ8tQ.woff2) format('woff2')}.material-icons{font-family:'Material Icons';font-weight:normal;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-feature-settings:'liga';-webkit-font-smoothing:antialiased}</style></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->25<!-- --> of <!-- -->28</div><div class="float-end"><a href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Spring Security</a></div></section><div class="clearfix"></div><section><div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"><div class="offcanvas-header border-bottom p-0 px-3 header_active__mLmmf"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasRight" aria-label="Close"></button></div><div class="offcanvas-body p-0"><h1 class="fw-light text-center m-3">Spring Security</h1><h3 class="fs-3 text-center text-muted m-3">Contents</h3><section><div class="list-group list-group-flush"><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">01. Bootstrap The Application</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">1<!-- -->. <!-- -->Introduction</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">2<!-- -->. <!-- -->Install Spring Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">3<!-- -->. <!-- -->Enable Basic Auth</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">4<!-- -->. <!-- -->Authentication with AppUser</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">5<!-- -->. <!-- -->Password Encoder</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">02. Web Layer Security - RBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">6<!-- -->. <!-- -->Permit Public APIs</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">7<!-- -->. <!-- -->Role Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">8<!-- -->. <!-- -->Disable CSRF</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">9<!-- -->. <!-- -->Current Authenticated User</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">03. Web Layer Security - PBAC</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">10<!-- -->. <!-- -->Permission Based Authorization</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">11<!-- -->. <!-- -->Define Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">12<!-- -->. <!-- -->Assign Permissions</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">13<!-- -->. <!-- -->Remove Role Based Access</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">04. Service Layer Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">14<!-- -->. <!-- -->PreAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">15<!-- -->. <!-- -->PostAuthorize</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">16<!-- -->. <!-- -->Authorize Using Spring Beans</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">05. Domain Object Instance Security</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">17<!-- -->. <!-- -->Domain Object Instance Security</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">18<!-- -->. <!-- -->PermissionEvaluator Interface</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">19<!-- -->. <!-- -->PermissionEvaluator Strategy</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">20<!-- -->. <!-- -->DB Backed UserDetailsService</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">06. Token Based Authentication</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">21<!-- -->. <!-- -->Basic Authentication Revisited</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">22<!-- -->. <!-- -->Generate Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">23<!-- -->. <!-- -->Persist Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">24<!-- -->. <!-- -->Verify Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6 Contents_active__vP5PJ"><span class="px-4">25<!-- -->. <!-- -->Invalidate Token</span></div></div><div class="list-group-item fs-5 text-bg-light border-bottom"><span style="color:cornflowerblue">07. Token Based Authentication and Authorization</span></div><div class="list-group list-group-flush"><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">26<!-- -->. <!-- -->JSON Web Token</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">27<!-- -->. <!-- -->Generate JWT</span></div><div class="list-group-item list-group-item-action cursor-pointer border-0 p-2 fs-6"><span class="px-4">28<!-- -->. <!-- -->Verify JWT</span></div></div></div></section></div></div></section><div class="mt-5"><div class="float-end"><a href="/assets/patches/spring-security/invalidate-token.patch" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/facade-code/spring-security-for-developers/tree/invalidate-token" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Invalidate Token</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Any web application allows the user to voluntarily logout or expires their session (not necessarily HttpSession) in case of inactivity for a long time. This can be done from SPA (Single Page Application) by just getting rid of the token stored somewhere and redirecting to the Login page. But the proper way to make this happen is to handle it with a dedicated and secured API to invalidate the token.</p></section><section><h3 class="fw-light mt-5 mb-2">Invalidate token service</h3><p class="Paragraph_paragraph__90U8D">We will create a <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark> in order to specifically update the <em>token</em> and <em>tokenExpiryTime</em> to null for the authenticated user identified by <em>username</em>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// Other methods omitted for brevity</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteToken</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-type">AppUser</span> <span class="hljs-variable">appUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.get(username);
        appUser.setToken(<span class="hljs-literal">null</span>);
        appUser.setTokenExpiryTime(<span class="hljs-literal">null</span>);
        appUserRepository.save(appUser);
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Now we will call the above method from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark> by passing the <em>username</em> retrieved from the authenticated <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object stored in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/service/AuthenticationService.java" target="_blank">AuthenticationService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationService</span> {
    <span class="hljs-comment">// Other methods omitted for brevity</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateToken</span><span class="hljs-params">()</span> {
        userService.deleteToken(authenticationFacade.getAuthentication().getName());
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Invalidate token API</h3><p class="Paragraph_paragraph__90U8D">Let&#x27;s create a REST API which calls the above service method to invalidate the token.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/controller/AuthenticationController.java" target="_blank">AuthenticationController.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(&quot;auth&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationController</span> {
    <span class="hljs-comment">// Other details omitted for brevity</span>

    <span class="hljs-meta">@DeleteMapping(&quot;token&quot;)</span>
    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">invalidateToken</span><span class="hljs-params">()</span> {
        authenticationService.invalidateToken();
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Secure delete token service</h3><p class="Paragraph_paragraph__90U8D">Similar to <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> service method we should not allow anyone to delete the token anonymously. We will secure the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> service method with the same pre-authorize condition as in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> to ensure only the authenticated user deletes his own token. Let&#x27;s define a constant variable in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authority</mark> class exclusively for authorizing the user to delete the token and annotate the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/facade-code/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(Authority.DELETE_TOKEN)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteToken</span><span class="hljs-params">(String username)</span> {
    <span class="hljs-comment">// Other details omitted for brevity</span>
}
</span></code></pre></div><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">Please note we do not need to change anything in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark>, as we have configured <em>/auth/token</em> endpoint to be public only for POST method. So DELETE method is secured by default letting only the authenticated user to delete/invalidate his own token.</p></section><p class="Paragraph_paragraph__90U8D">Restart the application, and generate a token from <u>GenerateToken</u> API with Admin user credential. Now send a DELETE request to the same endpoint with the generated token as Bearer Token. This will reset the token and tokenExpiryTime column for the Admin user to null in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">APP_USER</mark> table. We can no more use the same token for any protected APIs for the Admin user.</p></section><section><h3 class="fw-light mt-5 mb-2">Downside of Opaque Tokens</h3><p class="Paragraph_paragraph__90U8D">With so many steps to implement token-based authentication mechanism, it is quite not simpler than the out of the box Basic Auth. Though it is quite effective and efficient and addresses most of the issues of Basic Auth but it also comes along with its own limitations. And this is not because of the authentication mechanism itself, but because of the type of the token we are using so far.</p><ul><li>These tokens are called <strong>opaque tokens</strong>, as the name implies we can not get any information out of the random string. There is no way to verify from the token to whom it was issued to (Subject).</li><li>Single Page Applications (SPA) receiving this token can not decide what the user is allowed to do in the user interface from the token. It has to depend on a separate endpoint (in most cases it ends with url <em>/me</em> or <em>/profile</em>) to get the user profile and their permissions. These tokens can only be used as a means of authentication and not for authorization.</li><li>As these are opaque tokens, it should always be backed by a persistent datastore. In our case we had to associate the token with the user and it&#x27;s expiry time in the database along with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record.</li><li>API request spanning multiple microservices, where the token has to be relayed across each microservice requires a round trip to the datastore in each microservice just to validate the token.</li></ul></section><div class="mt-5"><section><div class="row border-top border-bottom py-2 mt-2"><div class="col-12 col-md-6 col-lg-6 text-center text-md-start"><div><div class="text-muted"><i class="bi-arrow-left-short mx-1 align-middle invisible d-none d-md-inline-block"></i>Previous</div><div><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i><a href="/courses/spring-security/lessons/verify-token">Verify Token</a></div></div></div><div class="col-12 col-md-6 col-lg-6 text-center text-md-end"><div><div class="text-muted">Next<i class="bi-arrow-right-short mx-1 align-middle invisible d-none d-md-inline-block"></i></div><div><a href="/courses/spring-security/lessons/json-web-token">JSON Web Token</a><i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></div></div></div></div></section></div></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="bg-dark"><div class="py-5"><div class="container"><div class="row"><div class="col-12 col-md-6 m-3 m-md-0"><div class="logo_logo__RXjG7 cursor-pointer text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div><div class="logo_logoCaption__h__G1">Simple bite-sized lessons to learn complex concepts</div></div><div class="col-12 col-md-3 m-3 m-md-0"><a href="/aboutme" class="footer_home__36kMG"><strong>ABOUT ME</strong></a></div><div class="col-12 col-md-3 m-3 m-md-0"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div><div class="text-center py-2 footer_copyright__mlBDD">Copyright © 2022 FacadeCode</div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/invalidate-token","query":{},"buildId":"jrh1wZfexw-7t3We4dymB","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>